image: python:3.7-stretch

stages:
  - package
  - build_installer

.install_opsi_dev_tools: &install_opsi_dev_tools |
  apt update
  apt -y install wget cpio unar
  wget "$OPSIDEVTOOLS_URL_LINUX_X64" -O opsi-dev-tools.tar.gz
  tar -xvf opsi-dev-tools.tar.gz

.install_opsi_utils: &install_opsi_utils |
  apt update
  apt -y install zsync librsync-dev cpio
  ./opsi-dev-tool --binary-pull development opsi-utils linux x64 latest ./
  useradd opsiconfd
  groupadd pcpatch
  groupadd opsiadmin
  adduser opsiconfd pcpatch
  adduser opsiconfd opsiadmin

build_installer:windows-x86-installer:
  stage: package
  tags:
    - win10
  script:
    - Invoke-WebRequest -UseBasicParsing -Uri "$OPSIDEVTOOLS_URL_WINDOWS_X86" -OutFile opsi-dev-tools.zip
    - Expand-Archive opsi-dev-tools.zip -DestinationPath opsi-dev-tools
    - Invoke-WebRequest -UseBasicParsing -Uri "http://binaryindex.uib.gmbh/mirror/resource_hacker/windows/x86/resource_hacker_windows_x86_5.1.8.zip" -OutFile resource_hacker.zip
    - Expand-Archive resource_hacker.zip -DestinationPath .
    - .\\opsi-dev-tools\\opsi-dev-tool.exe -l debug --binary-pull
    # Build 7z sfx installer
    - .\\oca-installer\\build.ps1 CLIENT_DATA opsi-client-agent-installer.exe
    # Compile versioninfo resource
    - "$versionLine = Get-Content -Path OPSI\\control | Where-Object { $_ -match 'version: 4.' }"
    - $version = $versionLine.Split(':')[1].trim()
    - $versionComma = $version -replace "\.",","
    - ((Get-Content -path oca-installer\\versioninfo.rc -Raw) -replace "{version}",$version -replace "{version_comma}",$versionComma) | Set-Content -Path oca-installer\\versioninfo.rc
    - .\\resourcehacker\\ResourceHacker.exe -open oca-installer\\versioninfo.rc -save oca-installer\\versioninfo.res -action compile -log reshack.log
    - Start-Sleep -s 5
    - Get-Content reshack.log
    # Replace versioninfo resource in exe
    - .\\resourcehacker\\ResourceHacker.exe -resource oca-installer\\versioninfo.res -open opsi-client-agent-installer.exe -save opsi-client-agent-installer.exe -action addoverwrite -log reshack.log
    - Start-Sleep -s 5
    - Get-Content reshack.log
    # Replace icon in exe
    - .\\resourcehacker\\ResourceHacker.exe -open opsi-client-agent-installer.exe -save opsi-client-agent-installer.exe -action addoverwrite -res oca-installer\\opsi.ico -mask "ICONGROUP,MAINICON," -log reshack.log
    - Start-Sleep -s 5
    - Get-Content reshack.log
    # Sign exe
    - .\\opsi-dev-tools\\opsi-dev-tool.exe -l info --signserver-sign opsi-client-agent-installer.exe
    # Push to binaryindex
    - if (! $CI_COMMIT_TAG) {.\\opsi-dev-tools\\opsi-dev-tool.exe -l info --binary-push opsi-client-agent-installer.exe opsi-client-agent-installer windows x86 $version "$CI_JOB_ID"}
    - if ($CI_COMMIT_TAG) {.\\opsi-dev-tools\\opsi-dev-tool.exe -l info --binary-push opsi-client-agent-installer.exe opsi-client-agent-installer windows x86 $version }

package:make_opsi_package:
  stage: package
  dependencies:
    - build_installer:windows-x86-installer
  script:
    - *install_opsi_dev_tools
    - *install_opsi_utils
    - ./opsi-dev-tool -l debug --binary-pull
    - version=`grep OPSI/control -A 10 -e "\[Product\]" | grep "version:" | tr -d "^a-zA-Z :"`
    - package=`grep OPSI/control -A 5 -e "\[Package\]" | grep "version:" | tr -d "^a-zA-Z :"`
    - '[ "$CI_COMMIT_TAG" = "" ] && sed -i "s/version: $package/version: $package.$CI_JOB_ID/" OPSI/control'
    - mv opsi-client-agent-installer.exe CLIENT_DATA/
    - opsi-utils/opsi-makepackage --no-set-rights -l 6
    - mkdir opsi-client-agent-package
    - cp ./opsi-client-agent*.opsi* opsi-client-agent-package/
    - '[ "$CI_COMMIT_TAG" = "" ] && ./opsi-dev-tool -l info --uib-binaryindex-url=http://opsipackages.uib.gmbh --binary-push opsi-client-agent-package opsi-client-agent all all "$version-$package" "$CI_JOB_ID"'
    - '[ "$CI_COMMIT_TAG" = "" ] || ./opsi-dev-tool -l info --uib-binaryindex-url=http://opsipackages.uib.gmbh --binary-push opsi-client-agent-package opsi-client-agent all all "$version-$package"'
