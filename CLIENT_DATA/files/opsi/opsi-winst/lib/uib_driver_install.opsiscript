encoding=utf8

;@author          detlef oertel
;@email           d.oertel@uib.de
;@date            27.08.2013
;@copyright       AGPLv3
;@version         1.0
;@filedesc        Collection of functions that helps to install driver

; ###################################################################################################
Deffunc install_driver_recursive_from_dir($driverdir$ : string, ref $errorstrings$ : stringlist) : string
  ;@author          detlef oertel
  ;@date            17.5.2018
  ;@Description     Sets for the given list of opsi productIds the action request
  ;@Description     to 'setup' (also resolving the dependencies)
  ;@Returns         Returns string "true" if all is ok
  ;@OnError         Returns string "false"
  ;@SpecialCase     Works only in opsi service mode (not in interactive or batch mode)
  ;@References
  ;@Links
  ;@ParamDesc_$productlist$     List of opsi product Ids
  ;@ParamAdvice_$productlist$
  ;@Example     [actions]
  ;@Example     DefStringlist $productlist$
  ;@Example
  ;@Example     set $productlist$ = CreateStringList("opsi-logviewer","opsi-configed")
  ;@Example     if not(stringtobool(setProductsToSetup($productlist$)))
  ;@Example       comment "call of setProductsToSetup failed"
  ;@Example     endif
  
  
	DefStringlist $list$
	DefStringlist $output$
	DefVar $exitcode$
	
	set $result$ = "true"
	comment "Import Driver Certificates ......"
	ChangeDirectory $driverdir$
	set $list$ = shellCall("dir /b/s *.cer")
	for %cert% in $list$ do sub_import_certificates
	
	comment "Install Driver ......"
	set $list$ = shellCall("dir /b/s *.inf")
	for %inffile% in $list$ do sub_install_driver_pnputil
	;for %inffile% in $list$ do set $ExitCode$ = processCall('%System%\pnputil.exe /add-driver "%inffile%" /install') /runelevated /sysnative
	;for %inffile% in $list$ do set $ExitCode$ = shellCall('%System%\pnputil /add-driver "%inffile%" /install')
	if $result$ = "false"
		;retry with dpinst
		sub_install_driver_dpinst
	endif
	
	[sub_import_certificates]
	set $output$ = shellCall('certutil.exe -f -addstore "TrustedPublisher" %cert%')
	set $exitcode$ = getlastexitcode
	if not($exitcode$ = "0")
		set $result$ = "false"
		set $errorstrings$ = addListToList($errorstrings$,$output$)
	endif
	
	[sub_install_driver_pnputil]
	set $output$ = shellCall('%System%\pnputil /add-driver "%inffile%" /install')
	set $exitcode$ = getlastexitcode
	if not($exitcode$ = "0")
		set $result$ = "false"
		set $errorstrings$ = addListToList($errorstrings$,$output$)
	endif
	
	[sub_install_driver_dpinst]
	if fileexists("%SystemRoot%\DPINST.LOG")
		Files_del_dpinstlog
	endif
	;Files_copy_driver_temp
	set $exitcode$ = shellCall('"%scriptpath%\drivers\cats\dpinst-amd64.exe" /s /c /se /sa /sw /f /lm /el /c')
	;set $output$ = shellCall('"%scriptpath%\drivers\cats\dpinst-x86.exe" /s /se /sa /sw /f /lm /el /c')
	;set $output$ = getOutstreamFromSection('ShellInAnIcon_dpinst')
	includelog "%SystemRoot%\DPINST.LOG" "100" "unicode"
	;set $exitcode$ = getlastexitcode
	if not($exitcode$ = "0")
		set $result$ = "false"
		;set $errorstrings$ = addListToList($errorstrings$,$output$)
	endif
	;Files_del_driver_temp
	
	[Files_del_dpinstlog]
	del -f "%SystemRoot%\DPINST.LOG"
	
	[Files_copy_driver_temp]
	copy -s "%scriptpath%\drivers\cats\*.*" "%opsiTmpDir%\davinci"
	
	[Files_del_driver_temp]
	del -sf "%opsiTmpDir%\davinci\"
	
	[ShellInAnIcon_dpinst]
	"%opsiTmpDir%\davinci\dpinst-amd64.exe" /s /c /se
endfunc

; ###################################################################################################
